
<!--左邊資訊欄-->
{% macro render1(room) %}
  <div id="render1" class="card h-50" style="overflow: auto">
    <table v-show="details" class="table table-bordered" style="display: none; table-layout: fixed; word-break: break-all; font-size: 14px; margin-bottom: 0">
      <thead>
        <tr class="text-center">
          <th width="25%">槽</th>
          <th width="75%">值</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(value, key) in details" :key="key" class="text-center">
          <td v-text="key"></td>
          <td v-text="prettify(key, value)" :title="fulltext(value)"></td>
        </tr>
      </tbody>
    </table>
    <div v-if="!details" class="d-flex h-100">
      <div class="my-auto mx-auto text-muted" v-text="'請先選其中一條紀錄'"></div>
    </div>
  </div>
  <div id="render4" class="d-flex card h-50 " style="overflow: auto">
    <div class="card-body">
      <h4>添加意圖</h4>
      <div style="font-size: 15px;">輸入當前對話的Intention、Domain、Slot及Value，按下按鈕添加意圖(action)</div>
      <hr>
      <div class="input-group mb-3" >
        <span class="pt-1 pb-1 px-1">你當前的對話: &nbsp;</span><span class="chatmsg-right rounded md-mt-mb-5 pt-1 pb-1 px-1" id="currentMsg"></span>
      </div>
      <div class="input-group mb-3">
        <div class="input-group-prepend"> 
          <label class="input-group-text" for="intention">Intention</label>
        </div>
        <select id="intention" class="custom-select" onchange="setDomain(this.id)">
          <option value="" selected> </option>
        </select>
        <!--<input id="intention" type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">-->
      </div>
      <div class="input-group mb-3">
        <div class="input-group-prepend">
          <span class="input-group-text" id="inputGroup-sizing-default">Domain&nbsp;&nbsp;&nbsp;</span>
        </div>
        <select id="domain" class="custom-select" onchange="setSlot(this.id)">
          <option value="" selected> </option>
        </select>
        <!--<input id="domain" type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">-->
      </div>
      <div class="input-group mb-3">
        <div class="input-group-prepend">
          <span class="input-group-text" id="inputGroup-sizing-default">Slot&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
        </div>
        <select id="slot" class="custom-select">
          <option value="" selected> </option>
        </select>        
        <!--<input id="slot" type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">-->
      </div>
      <div class="input-group mb-3">
        <div class="input-group-prepend">
          <span class="input-group-text" id="inputGroup-sizing-default">Value&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
        </div>
        <input id="value" type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">
      </div>         
      <button class="btn btn-light btn-block" onclick="addelement();">添加意圖</button>
    </div>
  </div>
{% endmacro %}

<!--中間搜尋欄-->
{% macro render2(room) %} 
  
  <ul class="nav nav-tabs nav-fill">
    <li class="nav-item"><a href="#render2" class="nav-link active" data-toggle="tab">查詢</a></li>
    <li class="nav-item"><a href="#render3" class="nav-link" data-toggle="tab">傳送/建立</a></li>
  </ul>
  <div id="myTabContent" class="tab-content" style="height: 95%;">
    <div id="render2" class="card h-100 tab-pane in active" style="overflow: auto;">
      <div class="d-flex px-1 py-1" style="background-color: #fff; min-height: 40px;">
        <button @click="submitForm" class="btn btn-sm btn-danger px-3 ml-auto" disabled :disabled="!canSubmit">提交表單</button>
      </div>
      <div style="min-height: 30%; max-height: 30%; overflow: auto; border-bottom: 1px solid #dee2e6;">
        <!--checkbox表格-->
        <table v-show="result.length" class="table table-striped table-bordered" style="display: none; table-layout: fixed; word-break: break-all; font-size: 14px; margin-bottom: 0">
          <thead>
            <tr>
              <th class="text-center" width="10%"></th>
              <th width="90%">名稱</th>
            </tr>
          </thead>
          <tbody>
            <!--載入-->
            <tr v-for="(item, index) in result" :key="index">              
              <!--產生checkbox-->
              <td class="text-center"><input v-model="item[2]" type="checkbox"></td>
              <td><a href="javascript:void(0)" @click="showResult(item[1])" v-text="item[0]"></a></td>
            </tr>
          </tbody>
        </table>
        <div v-if="!result.length" class="d-flex h-100">
          <div class="my-auto mx-auto text-muted" v-text="'暫無紀錄'"></div>
        </div>
      </div>
      <ul class="nav nav-tabs nav-fill pt-2">
        <li v-for="(_, field) in query" :key="field" class="nav-item">
          <a @click="activeField = field" :class="'nav-link' + (activeField === field ? ' active' : '')" href="javascript:void(0)" v-text="field"></a>
        </li>
      </ul>
      <div v-show="initialized" class="card-body" style="overflow: auto; display: none;">
        <div @keyup.enter="submit">
          <div v-for="(item, name) in query[activeField]" :key="activeField + name" class="form-group row">
            <label class="col-3 col-form-label col-form-label-sm" v-text="name"></label>
            <template v-if="item.type === 'between'">
              <div class="col-4">
                <input v-model="item.params[0]" type="datetime-local" class="form-control form-control-sm">
              </div>
              <div class="ml-auto">~</div>
              <div class="col-4 ml-auto">
                <input v-model="item.params[1]" type="datetime-local" class="form-control form-control-sm">
              </div>
            </template>
            <div v-else-if="item.type === 'choose'" class="col-9">
              <select v-model="item.params" class="form-control form-control-sm form-select" aria-label="Default select example">
                <option value="是">是</option>
                <option value="否">否</option>
              </select>
            </div>
            <div v-else class="col-9">
              <input v-model="item.params" class="form-control form-control-sm">
            </div>
          </div>
          <button class="btn btn-primary btn-block" @click="submit" :disabled="locking">查詢</button>
        </div>
      </div>
    </div>

    <div id="render3" class="card h-100 tab-pane fade" style="overflow: auto">
      <div class="d-flex px-1 py-1" style="background-color: #fff; min-height: 40px;">
        <button @click="submitForm" class="btn btn-sm btn-danger px-3 ml-auto" disabled :disabled="!canSubmit">提交表單</button>
      </div>
      
      <ul class="nav nav-tabs nav-fill pt-2">
        <li v-for="(_, field) in query" :key="field" class="nav-item">
          <a @click="activeField = field" :class="'nav-link' + (activeField === field ? ' active' : '')" href="javascript:void(0)" v-text="field"></a>
        </li>
      </ul>
      
      <div @keyup.enter="submit">
        <table class="table table-striped table-bordered" style="table-layout: fixed; word-break: break-all; font-size: 14px; margin-bottom: 0">
          <thead>
            <tr class="text-center">
              <th width="8%"></th>
              <th width="24%">槽</th>
              <th width="40%">值</th>
            </tr>
          </thead>   
          
          <tbody>
            <tr v-for="item in items" :key="activeField + item[0]" class="data-rows text-center">
              <td><input v-model="item[1].checked" type="checkbox"></td>
              <td v-text="item[0]"></td>
              <td v-if="item[1].type === 'between'">                  
                <input v-model="item[1].params[0]" type="datetime-local" class="form-control form-control-sm">                  
                <div class="ml-auto">~</div>                  
                <input v-model="item[1].params[1]" type="datetime-local" class="form-control form-control-sm">                  
              </td>
              <td v-else-if="item[1].type === 'choose'">
                <select v-model="item[1].params" class="form-control form-control-sm form-select" aria-label="Default select example">
                  <option value="是">是</option>
                  <option value="否">否</option>
                </select>
              </td>
              <td v-else >
                <input v-model="item[1].params" class="form-control form-control-sm">
              </td>
            </tr>
          </tbody>            
        </table>
        <!--<button class="btn btn-info btn-block" @click="send" disabled :disabled="!canSubmit">傳送/建立</button>-->
      </div>      
    </div>
  </div>
{% endmacro %}

{% macro script(room) %}
  <script type="text/javascript">
    

    var googleDate = /^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})\.(\d{3})([+-]\d{2}):(\d{2})$/;

    function parseGoogleDate(d) {
        var m = googleDate.exec(d);
        var year   = +m[1];
        var month  = +m[2];
        var day    = +m[3];
        var hour   = +m[4];
        var minute = +m[5];
        var second = +m[6];
        var msec   = +m[7];
        var tzHour = +m[8];
        var tzMin  = +m[9];
        var tzOffset = tzHour * 60 + tzMin;

        return Date.UTC(year, month - 1, day, hour, minute - tzOffset, second, msec);
    }
    //console.log(parseGoogleDate('2012-07-04T18:10:00.000+09:00'));

    function resetElement() {
      document.getElementById("intention").value='';
      document.getElementById("domain").value='';
      document.getElementById("slot").value='';
      document.getElementById("value").value='';
    }

    var intentions = []
    function addelement() {
      var intent = document.getElementById("intention").value;
      var domain = document.getElementById("domain").value;
      var slot = document.getElementById("slot").value;
      var values = document.getElementById("value").value;
      intentions.push([
        intent,
        domain,
        slot,
        values
      ]);
      resetElement();
    }    

    const vm1 = new Vue({
      el: '#render1',
      data () {
        return {
          details: null
        }
      },
      methods: {
        update (details) {
          this.details = details
        },
        prettify (key, value) {
          if (value === null) return '無'
          if (value instanceof Array) {
            if (!value.length) return '無'
            disp = []
            let length = value.length
            if (/^裡/.test(key)) {
              length = Math.min(length, 5)
            }
            for (let i = 0; i < length; ++i) {
              disp.push(value[i])
            }
            return disp.join(', ') + (value.length !== length ? ' ...' : '')
          }
          return value
        },
        fulltext (value) {
          if (value === null) return
          if (value instanceof Array) {
            disp = []
            for (let i = 0; i < value.length; ++i) {
              disp.push(value[i])
            }
            return disp.join(', ')
          }
          return value
        }
      }
    })
    // system 中間的搜尋欄
    const vm2 = new Vue({
      el: '#render2',
      data () {
        return {
          canSubmit: false,
          query: {
            'Calendar': {
              '活動名稱': { params: null },
              '活動時間': { type: 'between', params: [null, null] },
              '參加者': { type: 'multiple_in', params: null },
              '是否全天': { type: 'choose', params: null },
              '活動內容': { params: null },
              '活動地點': { params: null }
            },
            'Gmail': {
              '收件者': { type: 'multiple_in', params: null },
              '寄件者': { params: null },
              '郵件主旨': { params: null },
              '信件內容': { params: null },
              '副本收件者': { type: 'multiple_in', params: null },
              '密件副本收件者': { type: 'multiple_in', params: null }
            },
            'Line': {
              '收件者': { type: 'multiple_in', params: null },
              '傳送內容': { params: null }
            }            
          },
          activeField: 'Calendar',
          result: [],
          history: [],
          database: {},
          locking: false,
          initialized: false
        }
      },
      methods: {
        showResult (details) {
          vm1.update(details)
        },
        syncLastResult () {
          const p = this.history.length - 1
          if (p < 0) return
          // console.log(this.history)
          // console.log(p, this.history[p])
          delete this.history[p].result
          this.history[p].selectedResults = this.result.filter(item => item[2]).map(item => item[0])
        },
        async ask (payload) {
          const db = this.database[payload.field]
          const contains = (arr, s) => {
            console.log(arr)
            return !arr.filter(item => !(item.indexOf(s) < 0)).length
          }
          
          if (!db) return []
          payload.result = db.filter(item => {
            const details = item[1]
            for (let key in payload.query) {
              const val = details[key]
              const absence = val === null
              const options = payload.query[key]
              if (options.type === 'between') {
                let L = -Infinity
                let R =  Infinity
                
                if (options.params[0] || (typeof options.params[0] === 'string')) {
                  L = options.params[0]
                  if (absence) return false
                } else {
                  options.params[0] = null
                }
                if (options.params[1] || (typeof options.params[1] === 'string')) {
                  R = options.params[1]
                  if (absence) return false
                } else {
                  options.params[1] = null
                }
                if (L > val || val > R) {
                  return false
                }
              } else if (options.type === 'in') {
                if (options.params) {
                  if (absence) return false
                  if (contains(val, options.params)) {
                    return false
                  }
                } else {
                  options.params = null
                }
              } else if (options.type === 'multiple_in') {
                if (options.params) {
                  if (absence) return false
                  if (!(options.params instanceof Array)) {
                    options.params = options.params.split(', ').filter(s => !!s)
                  }
                  if (options.params.filter(s => contains(val, s)).length) {
                    return false
                  }
                } else {
                  options.params = null
                }
              } else {
                if (options.params) {
                  console.log(options.params)
                  if (absence) return false
                  if (val.indexOf(options.params) < 0) {
                    return false
                  }
                } else {
                  options.params = null
                }
              }
            }
            return payload
          }).map(item => item.concat(false))
          console.log('res',payload.result)
        },
        async submit () {
          if (this.locking) return true
          this.locking = true
          this.syncLastResult()
          let payload = JSON.parse(JSON.stringify({
            field: this.activeField,
            query: this.query[this.activeField],
            timestamp: Date.now()
          }))
          try {
            await this.ask(payload)
            this.result = payload.result
            this.history.push(payload)
          } catch (err) {
            console.error(err)
          } finally {
            this.locking = false
          }
        },
        async loaddb () {
          const f = (path, name) => {
            return axios.get(path).then(response => {
              this.database[name] = response.data
            })
          }
          return Promise.all([
            f('/static/data/calendar_db.json', 'Calendar'),
            f('/static/data/gmail_db.json', 'Gmail'),
            //f('/static/data/line_db.json', 'Line')
          ])
        },
        async submitForm () {
          if (!this.canSubmit) return
          if (!intentions.length){
            alert('未完成意圖標記！');
            return
          }else if (intentions.length && !confirm('是否已經完成意圖標記？'))return 
          else {
            if (!this.result.filter(item => item[2]).length) {
              if (!confirm('為選重任何內容，確定要提交嗎？')) return
            }
            let payload = JSON.parse(JSON.stringify({
              field: this.activeField,
              query: this.query[this.activeField],
              timestamp: Date.now()
            }))
            //if (!this.history.length) {
            this.history.push(JSON.parse(JSON.stringify({
              field: this.activeField,
              dialog_act: intentions,
              query: this.query[this.activeField],
              timestamp: 0
            })))
            //}
            this.syncLastResult()
            try {
              // console.log(JSON.parse(JSON.stringify(this.history)))
              await axios.post(`/room/{{ room.id }}/0/message/payload`, {
                payload: this.history
              })
              if (this.history.length) {
                this.history = [this.history.pop()]
              }
              this.result.map(item => (Vue.set(item, 2, false)))
              this.canSubmit = false
              console.log(intentions)
              intentions = []
            } catch (err) {
              console.error(err)
            }
          }
        }
          
      },
      mounted () {
        if (window.localStorage['systemsideData{{ room.id }}']) {
          const data = JSON.parse(window.localStorage['systemsideData{{ room.id }}'])
          this.activeField = data.activeField
          this.query = data.query
          this.result = data.result
          this.history = data.history
        }
        this.initialized = true
        this.loaddb()
        setInterval(() => {
          // console.log(this.history.length)
          window.localStorage['systemsideData{{ room.id }}'] = JSON.stringify({
            activeField: this.activeField,
            dialog_act: intentions,
            query: this.query,
            result: this.result,
            dialog_act: intentions,
            history: (this.history.length ? [this.history[this.history.length - 1]] : [])
          })
        }, 500)
      }
    })

    const vm3 = new Vue({
      el: '#render3',
      data () {     
        return {
          canSubmit: false,
          query: {
            'Calendar': {
              '活動名稱': { params: null, checked: false },
              '活動時間': { type: 'between', params: [null, null], checked: false },
              '參加者': { type: 'multiple_in', params: null, checked: false },
              '是否全天': { type: 'choose', params: null, checked: false },
              '活動內容': { params: null, checked: false },
              '活動地點': { params: null, checked: false }
            },
            'Gmail': {
              '收件者': { type: 'multiple_in', params: null, checked: false },
              '寄件者': { params: null, checked: false },
              '郵件主旨': { params: null, checked: false },
              '信件內容': { params: null, checked: false },
              '副本收件者': { type: 'multiple_in', params: null, checked: false },
              '密件副本收件者': { type: 'multiple_in', params: null, checked: false }
            },
            'Line': {
              '收件者': { type: 'multiple_in', params: null, checked: false },
              '傳送內容': { params: null, checked: false }
            }            
          },
          activeField: 'Calendar',          
          items: this.items,
          result: [],
          history: [],
          locking: false,
          initialized: false
        }
      },
      methods: {
        toArray(query_array){
          var dict = query_array;
          var arr = [];

          for (var key in dict) {
              if (dict.hasOwnProperty(key)) {
                  arr.push( [ key, dict[key]] );
              }
          }
          return arr
        },
        async send () {
          await axios.post(`/write`, {
              payload: this.history
            })
        },
        async submitForm () {  // To-Do: 改為
          console.log('this.items', this.items)
          console.log('this.items.filter(item => item[2]).length', this.items.filter(item => item[1].checked).length)
          if (!this.canSubmit) return
          if (!intentions.length){
            alert('未完成意圖標記！');
            return
          }else if (intentions.length && !confirm('是否已經完成意圖標記？'))return 
          else {
            if (!this.items.filter(item => item[1].checked).length) {
              if (!confirm('未選擇任何內容，確定要發送嗎？')) return
            }
            /*let payload = JSON.parse(JSON.stringify({
            field: this.activeField,
            query: this.query[this.activeField],
            timestamp: Date.now()
          }))*/
            if (!this.history.length) {
              this.history.push(JSON.parse(JSON.stringify({
                field: this.activeField,
                dialog_act: intentions,
                query: this.query[this.activeField],
                timestamp: 0
              })))
            }
            //this.syncLastResult()
            try {
              // console.log(JSON.parse(JSON.stringify(this.history)))
              await axios.post(`/room/{{ room.id }}/0/message/payload`, {
                payload: this.history
              })
              if (this.history.length) {
                this.history = [this.history.pop()]
              }
              this.items.map(item => {
                if (item[1].type== 'between'){
                  item[1].params = [null, null]
                }else{
                  item[1].params = null
                }
                item[1].checked = false
              })
              this.canSubmit = false
              console.log(intentions)
              intentions = []
            } catch (err) {
              console.error(err)
            }
          }
        }
      },
      mounted () {        
        console.log('query', this.query[this.activeField])
        console.log('activeField', this.activeField)
        if (window.localStorage['systemsideData{{ room.id }}']) {
          
          const data = JSON.parse(window.localStorage['systemsideData{{ room.id }}'])
          this.activeField = data.activeField
          this.query = data.query
          this.result = data.result
          this.history = data.history
          this.items = this.toArray(this.query[this.activeField])
        }
        this.items = this.toArray(this.query[this.activeField]) 
        console.log('this.items', this.items)
        this.initialized = true
        this.locking = true
        setInterval(() => {
          // console.log(this.history.length)          
          window.localStorage['systemsideData{{ room.id }}'] = JSON.stringify({
            activeField: this.activeField,
            dialog_act: intentions,
            items: this.items,
            query: this.query,
            result: this.result,
            history: (this.history.length ? [this.history[this.history.length - 1]] : [])
          })
        }, 500)
      },
      beforeUpdate(){        
        this.items = this.toArray(this.query[this.activeField]) 
        console.log('query', this.query[this.activeField])
        console.log('activeField', this.activeField)
      }
    })

    
  </script>
{% endmacro %}

{% macro style() %}
  <style type="text/css">
    .table td, .table th {
      padding: 4px 12px;
      outline: none;
      vertical-align: middle;
    }
  </style>
{% endmacro %}
